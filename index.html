<!DOCTYPE html>
<html lang="de">
<head>
	<title>Puzzle</title>
</head>
<body>

<canvas id="playfield" width="0" heigth="0"></canvas>
<img id="image" src="puzzle.png">

<script>
   (function () {

      // class Cells ---------------------------------------------------------------------------------------------------

      function Cells( rows, columns ) {
         this.rows = rows,
         this.columns = columns,
         this.cells = new Array( this.rows * this.columns );
         var i, j, k = 0;
         for( i = 0; i < this.rows; ++i ) {
            for( j = 0; j < this.columns; ++j ) {
               this.cells[ k ] = { x: j, y: i };
               ++k;
            }
         }
      }

      Cells.prototype.cellIndex = function cellIndex(x, y) {
            return y * this.rows + x;
      };

      Cells.prototype.each = function each( callbackFunction ) {
         for (var y = 0; y < this.rows; ++y) {
            for (var x = 0; x < this.columns; ++x) {
               callbackFunction(x, y, this.cell(x, y) );
            }
         }
      };

      Cells.prototype.cell = function cell( x, y ) {
         return this.cells[ this.cellIndex(x, y) ];
      }

      Cells.prototype.exchange = function exchange(fromCell, toCell) {
         var toCellValue = this.cells[toCell];
         this.cells[toCell] = this.cells[fromCell];
         this.cells[fromCell] = toCellValue;
      }

      // ---------------------------------------------------------------------------------------------------------------

      var NUMBER_OF_COLUMNS = 5;
      var NUMBER_OF_ROWS = 5;

      var image = document.getElementById('image');
      var cellImageWidth = -1;
      var cellImageHeight = -1;

      var playFieldCanvas = document.getElementById('playfield');
      var playFieldContext = playFieldCanvas.getContext('2d');
      var selectedCellIndex = undefined;
      var cells = undefined;

      function drawCell(x, y, cell) {
         var imageOffsetX = cell.x * cellImageWidth;
         var imageOffsetY = cell.y * cellImageHeight;

         playFieldContext.drawImage( image, imageOffsetX, imageOffsetY,
                                     cellImageWidth, cellImageHeight,
                                     x * cellImageWidth, y * cellImageHeight,
                                     cellImageWidth, cellImageHeight );
        /*
         playFieldContext.beginPath();
         playFieldContext.rect(x * 50, y * 50, 50, 50);
         playFieldContext.fillText(cells[cellIndex(x, y)].y*NUMBER_OF_COLUMNS+x, x * 50 + 20, y * 50 + 30);
         playFieldContext.lineWidth = 1;
         playFieldContext.strokeStyle = 'black';
         playFieldContext.stroke();
         */
      }

      function drawPlayfield() {
         playFieldContext.clearRect(0, 0, playFieldCanvas.width, playFieldCanvas.height);
         cells.each( function toDraw( x, y, cell ) {
            drawCell( x, y, cell );
         });
      }

      function handleClickEvent(event) {
         var clickedCellX = Math.floor( event.offsetX / cellImageWidth );
         var clickedCellY = Math.floor( event.offsetY / cellImageHeight );
         var clickedCellIndex = cells.cellIndex( clickedCellX, clickedCellY );

         if( selectedCellIndex && selectedCellIndex != clickedCellIndex ) {
            cells.exchange( selectedCellIndex, clickedCellIndex );
            drawPlayfield();
            selectedCellIndex = undefined;
         } else {
            selectedCellIndex = clickedCellIndex;
         }
      }

      function initialise() {
         cells = new Cells(NUMBER_OF_ROWS, NUMBER_OF_COLUMNS);
         playFieldCanvas.addEventListener('click', handleClickEvent);
      }

      image.onload = function() {
         playFieldCanvas.width = this.width;
         playFieldCanvas.height = this.width;

         cellImageWidth = Math.floor( this.width / NUMBER_OF_COLUMNS );
         cellImageHeight = Math.floor( this.height / NUMBER_OF_ROWS );

         initialise();
         drawPlayfield();
      }


   }());
</script>

</body>
</html>
